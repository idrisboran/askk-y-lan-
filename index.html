<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Nisa & ƒ∞dris - Hƒ±zlƒ± D√ºello</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f8bbd0; background-image: radial-gradient(#f48fb1 1px, transparent 1px); background-size: 25px 25px; font-family: 'Quicksand', sans-serif; overflow: hidden; }
        canvas { border: 5px solid #8e24aa; border-radius: 15px; background-color: #fff; width: 75vw; height: 85vh; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        
        #side-panel { margin-left: 20px; display: flex; flex-direction: column; gap: 15px; width: 220px; }
        .panel-box { background: rgba(255, 255, 255, 0.9); padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        .score-box { font-size: 18px; font-weight: 700; color: #4a148c; margin-bottom: 5px; }
        .extra-score { font-size: 14px; color: #6a1b9a; margin-bottom: 10px; border-bottom: 1px dashed #ce93d8; padding-bottom: 5px; }
        #partner-area { color: #d81b60; border-top: 2px dashed #f06292; padding-top: 10px; margin-top: 10px; }
        
        #chat-area { display: flex; flex-direction: column; gap: 10px; }
        #msgInput { border: 2px solid #f06292; border-radius: 8px; padding: 8px; font-family: 'Quicksand'; outline: none; }
        #sendBtn, #restartBtn { background: #d81b60; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        #sendBtn:hover, #restartBtn:hover { background: #ad1457; }
        
        #restartBtn { background: #4a148c; margin-top: 10px; display: none; width: 100%; }

        #live-message { position: absolute; top: 50px; left: 50%; transform: translateX(-50%); background: white; border: 3px solid #d81b60; padding: 10px 25px; border-radius: 50px; font-size: 20px; font-weight: bold; color: #d81b60; display: none; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: pop 0.5s ease; }
        
        #game-over-text { position: absolute; top: 40%; left: 38%; transform: translate(-50%, -50%); color: #8e24aa; font-size: 35px; font-weight: 900; text-align: center; display: none; pointer-events: none; text-shadow: 2px 2px white; }

        @keyframes pop { 0% { transform: translateX(-50%) scale(0); } 100% { transform: translateX(-50%) scale(1); } }
    </style>
</head>
<body>
    <div id="live-message">üì© A≈ükƒ±ndan mesaj: <span id="msgContent"></span></div>
    <div id="game-over-text">YANDIN A≈ûKIM! <br> <span style="font-size: 18px;">Space veya Enter ile ba≈üla...</span></div>
    
    <canvas id="gameCanvas"></canvas>
    
    <div id="side-panel">
        <div class="panel-box">
            <div class="score-box">üë§ <span id="myNameLabel">-</span></div>
            <div class="extra-score">üèÜ En Y√ºksek: <span id="highScoreDisplay">0</span></div>
            <div class="extra-score">‚è™ √ñnceki: <span id="lastScoreDisplay">0</span></div>
            <div id="score" class="score-box">Skorum: 0</div>
            <div id="partner-area" class="score-box">üíñ <span id="partnerNameLabel">A≈ükƒ±m</span>: <span id="partnerScoreDisplay">0</span></div>
            <button id="restartBtn">Yeni Oyun (Enter) üéÆ</button>
        </div>

        <div class="panel-box" id="chat-area">
            <div style="font-weight: bold; color: #4a148c;">A≈ükƒ±na Laf At:</div>
            <input type="text" id="msgInput" placeholder="√áabuk kaybet!.." maxlength="30">
            <button id="sendBtn">G√∂nder üíå</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBq5Jp7JVXy6L_xJoJs2Kq8XmbdTUdBRKk",
            authDomain: "askkk-8ae99.firebaseapp.com",
            databaseURL: "https://askkk-8ae99-default-rtdb.firebaseio.com",
            projectId: "askkk-8ae99",
            storageBucket: "askkk-8ae99.firebasestorage.app",
            messagingSenderId: "769144248806",
            appId: "1:769144248806:web:31ee01fb4c496228525e27"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let myName = prompt("ƒ∞smini gir (Nisa/ƒ∞dris):", "ƒ∞dris");
        let partnerName = (myName.toLowerCase() === "nisa") ? "ƒ∞dris" : "Nisa";
        document.getElementById('myNameLabel').innerText = myName;
        document.getElementById('partnerNameLabel').innerText = partnerName;

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth * 0.75; 
        canvas.height = window.innerHeight * 0.85; 

        let box = 28; 
        let snake, direction, score, speed, gameInterval, isGameOver;

        // Hafƒ±zadan skorlarƒ± √ßekme
        function updateScoreBoard() {
            const high = localStorage.getItem('highScore_' + myName) || 0;
            const last = localStorage.getItem('lastScore_' + myName) || 0;
            document.getElementById('highScoreDisplay').innerText = high;
            document.getElementById('lastScoreDisplay').innerText = last;
        }

        function initGame() {
            snake = [{x: Math.floor(canvas.width / 2 / box) * box, y: Math.floor(canvas.height / 2 / box) * box}];
            direction = null;
            score = 0;
            speed = 100;
            isGameOver = false;
            document.getElementById('score').innerText = `Skorum: 0`;
            document.getElementById('restartBtn').style.display = 'none';
            document.getElementById('game-over-text').style.display = 'none';
            updateScoreBoard();
            sendScore(0);
            if(gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(draw, speed);
        }

        // Kendi g√∂vdesine √ßarpma kontrol√º
        function checkCollision(head, body) {
            for (let i = 0; i < body.length; i++) {
                if (head.x === body[i].x && head.y === body[i].y) return true;
            }
            return false;
        }

        document.addEventListener('keydown', e => {
            if (isGameOver && (e.key === 'Enter' || e.key === ' ')) {
                initGame();
                return;
            }
            if (isGameOver) return;
            if (e.key === 'ArrowUp' && direction !== 'down') direction = 'up';
            else if (e.key === 'ArrowDown' && direction !== 'up') direction = 'down';
            else if (e.key === 'ArrowLeft' && direction !== 'right') direction = 'left';
            else if (e.key === 'ArrowRight' && direction !== 'left') direction = 'right';
        });

        document.getElementById('sendBtn').onclick = () => {
            const text = document.getElementById('msgInput').value;
            if(text) {
                database.ref('messages/' + partnerName).set({ text: text, time: Date.now() });
                document.getElementById('msgInput').value = "";
            }
        };

        document.getElementById('restartBtn').onclick = () => initGame();

        database.ref('scores/' + partnerName).on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) document.getElementById('partnerScoreDisplay').innerText = data.currentScore;
        });

        database.ref('messages/' + myName).on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                const liveMsg = document.getElementById('live-message');
                document.getElementById('msgContent').innerText = data.text;
                liveMsg.style.display = 'block';
                setTimeout(() => { liveMsg.style.display = 'none'; }, 5000);
            }
        });

        function sendScore(s) {
            database.ref('scores/' + myName).set({ currentScore: s });
        }

        const cakeImage = new Image();
        cakeImage.src = 'https://pbs.twimg.com/media/DqxCSRUWoAAp1qz.jpg'; 
        let food = { x: Math.floor(Math.random() * 15) * box, y: Math.floor(Math.random() * 15) * box };

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            for (let i = 0; i < snake.length; i++) {
                ctx.fillStyle = (i === 0) ? '#4a148c' : '#7b1fa2';
                ctx.beginPath();
                ctx.arc(snake[i].x + box/2, snake[i].y + box/2, box/2, 0, Math.PI*2);
                ctx.fill();

                if(i === 0) {
                    ctx.fillStyle = "white";
                    ctx.beginPath();
                    ctx.arc(snake[i].x + box/2 + 5, snake[i].y + box/2 - 4, 4, 0, Math.PI * 2);
                    ctx.arc(snake[i].x + box/2 - 5, snake[i].y + box/2 - 4, 4, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = "black";
                    ctx.beginPath();
                    ctx.arc(snake[i].x + box/2 + 6, snake[i].y + box/2 - 4, 1.5, 0, Math.PI * 2);
                    ctx.arc(snake[i].x + box/2 - 4, snake[i].y + box/2 - 4, 1.5, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            ctx.drawImage(cakeImage, food.x, food.y, box * 1.8, box * 1.8);

            if (isGameOver) return; 

            let snakeX = snake[0].x;
            let snakeY = snake[0].y;
            if (direction === 'up') snakeY -= box;
            if (direction === 'down') snakeY += box;
            if (direction === 'left') snakeX -= box;
            if (direction === 'right') snakeX += box;

            let newHead = {x: snakeX, y: snakeY};

            // Yanma Ko≈üullarƒ±: Duvarlar VEYA Kendi G√∂vdesi
            if (direction && (snakeX < 0 || snakeX >= canvas.width || snakeY < 0 || snakeY >= canvas.height || checkCollision(newHead, snake))) {
                isGameOver = true;
                
                // Skor Kayƒ±t ƒ∞≈ülemleri
                localStorage.setItem('lastScore_' + myName, score);
                const currentHigh = localStorage.getItem('highScore_' + myName) || 0;
                if (score > currentHigh) {
                    localStorage.setItem('highScore_' + myName, score);
                }
                
                document.getElementById('restartBtn').style.display = 'block';
                document.getElementById('game-over-text').style.display = 'block';
                updateScoreBoard();
                return;
            }

            if (snakeX < food.x + box*1.8 && snakeX + box > food.x && snakeY < food.y + box*1.8 && snakeY + box > food.y) {
                score++;
                document.getElementById('score').innerText = `Skorum: ${score}`;
                sendScore(score);
                
                if(score % 7 === 0 && speed > 40) {
                    clearInterval(gameInterval);
                    speed -= 8;
                    gameInterval = setInterval(draw, speed);
                }
                food = { x: Math.floor(Math.random() * (canvas.width/box-2)) * box, y: Math.floor(Math.random() * (canvas.height/box-2)) * box };
            } else if(direction) {
                snake.pop();
            }

            if(direction) {
                snake.unshift(newHead);
            }
        }

        initGame();
    </script>
</body>
</html>
